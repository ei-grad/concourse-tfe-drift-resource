name: tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build:
    name: Tests
    runs-on: ubuntu-latest
    steps:

      - name: Set up Go 1.x
        uses: actions/setup-go@v2
        with:
          go-version: ^1.14
        id: go

      - name: Check out code into the Go module directory
        uses: actions/checkout@v2

      - name: Get dependencies
        run: |
          go get -v -t -d ./...
          GO111MODULE=on go get github.com/golang/mock/mockgen

      - name: Run tests
        uses: paambaati/codeclimate-action@v2.7.4
        env:
          CC_TEST_REPORTER_ID: ${{secrets.CODECLIMATE_REPORTER_ID}}
          TFE_ADDRESS: https://app.terraform.io
          TFE_ORGANIZATION: orstensemantics
          TFE_WORKSPACE: tfe-resource-test
          ATLAS_TOKEN: ${{secrets.ATLAS_TOKEN}}
        with:
          coverageCommand: |
            mkdir -p mock-go-tfe
            mockgen github.com/hashicorp/go-tfe Workspaces,Runs,Variables,StateVersions > mock-go-tfe/mocks.go
            go test -v -coverprofile coverage.out -covermode=count
          coverageLocations: ${{github.workspace}}/coverage.out
      - name: Publish coverage to codecov
        uses: codecov/codecov-action@v1
        with:
          file: ./coverage.out
